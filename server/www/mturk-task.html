<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Game Task</title>
        <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css'>
        <link rel='stylesheet' href='https://cdn.form.io/formiojs/formio.full.min.css'>
        <script src='https://cdn.form.io/formiojs/formio.full.min.js'></script>
    </head>
    <body>
        <script type="text/javascript">
            function validPreviewParams(params) {
                if (!params.has('assignmentId')) {
                    console.log('Missing assignmentId parameter.');
                    return false;
                }
                if (params.get('assignmentId') != 'ASSIGNMENT_ID_NOT_AVAILABLE') {
                    console.log('Not in preview mode.');
                    return false;
                }
                return true;
            }
            function validWorkerParams(params) {
                if (!params.has('workerId')) {
                    console.log('Missing workerId parameter.');
                    return false;
                }
                if (!params.has('assignmentId')) {
                    console.log('Missing assignmentId parameter.');
                    return false;
                }
                if (!params.has('turkSubmitTo'))
                {
                    console.log('Missing turkSubmitTo parameter.');
                    return false;
                }
                return true;
            }
        
            function onFormSubmit(event) {
                event.preventDefault();
                var params = new URLSearchParams(window.location.search);
                var htmlForm = document.createElement('form');
                htmlForm.action = (new URL('mturk/externalSubmit', params.get('turkSubmitTo'))).href
                console.log(htmlForm.action);
                htmlForm.method = 'post';

                // Add the assignment ID to the form.
                var assignmentIdInput = document.createElement("input");
                assignmentIdInput.setAttribute("type", "hidden");
                assignmentIdInput.setAttribute("name", "assignmentId");
                assignmentIdInput.setAttribute("value", params.get('assignmentId'));
                htmlForm.appendChild(assignmentIdInput);

                // Add the form data to the form.
                var checkbox = document.getElementById("verification");
                var formDataInput = document.createElement("input");
                formDataInput.setAttribute("type", "hidden");
                formDataInput.setAttribute("name", "userCheckbox");
                formDataInput.setAttribute("value", checkbox.checked);
                htmlForm.appendChild(formDataInput);

                // Submit the form.
                document.body.appendChild(htmlForm);
                htmlForm.submit();
            }

            window.onload = function() {
                var submissionButton = document.getElementById("submission_button");
                submissionButton.disabled = true;
                var params = new URLSearchParams(window.location.search);
                var statusElement = document.getElementById('status');
                if (validWorkerParams(params)) {
                    statusElement.innerHTML = 'Valid Amazon MTurk parameters. Proceed to task.';
                    statusElement.style.backgroundColor = '#7FFFD4';
                } else if (validPreviewParams(params)) {
                        statusElement.innerHTML = 'MTurk PREVIEW. You can preview the form, but you cannot submit it.';
                        statusElement.style.backgroundColor = 'yellow';
                } else {
                    statusElement.innerHTML = 'Missing Amazon MTurk parameters. Did you access this page through mechanical turk?';
                    statusElement.style.backgroundColor = 'red';
                }
            }

            function openInNewWindowForwardParams(url) {
                var mturkParameters = new URLSearchParams(window.location.search);
                var win = window.open(url + "&" + mturkParameters.toString(), '_blank');
                win.focus();
            }

            function openGameQueue() {
                openInNewWindowForwardParams("https://cerealbar2.com/?skipToTask=joinGameQueue");
            }

            function controlSubmitButton() {
                var checkbox = document.getElementById("verification");
                var submissionButton = document.getElementById("submission_button");
                var validationWarning = document.getElementById("validation_warning");
                submissionButton.disabled = !checkbox.checked;
                validationWarning.style.display = (checkbox.checked) ? "none" : "inline";
            }

        </script>
        <div>
            <h1>Game Task</h1>
            <h2 id="status"></h2>
            <h2>
                Steps
            </h2>
            <ol>
                <li><a id="game-link" href="#" onclick="openGameQueue()">Click here</a> to enter the game queue and play a game. You MUST use this link.</li>
                <li>Once a game has been completed, come back and hit "submit" below. You MUST hit the submit button after or you will not receive credit for your work.</li>
            </ol>
            <h2>What's New?</h2>
            <p style="margin-left: 15px">
                Make sure to check out <a href="/changelist">the changelist</a>!
            </p>
            <p style="background-color: rgb(255, 255, 170); font-size: 15px; display: block; margin-left: auto; margin-right: auto; text-align: center; width: 60%;">
                You are <b>strongly</b> encouraged to 
                <a href="https://discord.gg/RErZXMzN6G">join the discord</a> for
                support, updates and <b>notifications of new assignments</b>.
            </p>
            <h2>
                Game Submission
            </h2>
            <form id="qual-form" style="margin-left: 15px;" onsubmit="onFormSubmit(event)" method="post">
                <input type="checkbox" onclick="controlSubmitButton()" id="verification" name="verification" value="verified">
                <label for="verification">I used the link above to participate in a Cerealbar2 game. <span id="validation_warning" style="color: red">(required)</span></label><br>
                <input type="submit" id="submission_button" value="Submit">
            </form>
            <h2>Panda Script Policy</h2>
            <div id="panda-policy">
                    <img src="images/panda.jpeg" alt="Panda Script Policy" style="margin-left: 15px; height: 300px; display: inline-block;">
                    <p style="margin-left: 15px; vertical-align: top; display: inline-block; width:30%;">
                        Please only reserve 1 HIT at a time. Don't use "Panda" scripts to reserve HITs in bulk!
                    </p>
            </div>
    </body>
</html>
